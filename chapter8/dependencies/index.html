<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-wEmeIV1mKuiNpC+IOBjI7aAzPcEZeedi5yW5f2yOq55WWLwNGmvvx4Um1vskeMj0" crossorigin="anonymous">

  <title>Chapter 8 WebSockets Dependencies</title>
</head>

<body>
  <div class="container">
    <h1 class="my-3">Chapter 8 WebSockets Dependencies</h1>
    <form id="form-connect">
      <div class="input-group mb-3">
        <input id="username" type="text" class="form-control" placeholder="Username">
        <button class="btn btn-success" type="submit" id="button-connect">Connect</button>
      </div>
    </form>
    <form id="form-send">
      <div class="input-group mb-3">
        <input id="message" type="text" class="form-control" placeholder="Message" required disabled>
        <button class="btn btn-primary" type="submit" id="button-send" disabled>Send</button>
      </div>
    </form>
    <ul id="messages"></ul>
  </div>

  <script>
    const addMessage = (message, sender) => {
      const messages = document.getElementById('messages');

      const messageItem = document.createElement('li');
      messageItem.innerText = message;
      if (sender === 'client') {
        messageItem.setAttribute('class', 'text-success');
      } else {
        messageItem.setAttribute('class', 'text-warning');
      }

      messages.appendChild(messageItem);
    };

    const connectWebSocket = (username) => {
      document.cookie = 'token=SECRET_API_TOKEN';
      const socket = new WebSocket(`ws://localhost:8000/ws?username=${username}`);

      // Connection opened
      socket.addEventListener('open', function (event) {
        document.getElementById('message').removeAttribute('disabled');
        document.getElementById('button-send').removeAttribute('disabled');
        document.getElementById('username').setAttribute('disabled', 'true');
        document.getElementById('button-connect').setAttribute('disabled', 'true');

        // Send message on form submission
        document.getElementById('form-send').addEventListener('submit', (event) => {
          event.preventDefault();
          const message = document.getElementById('message').value;

          addMessage(message, 'client');

          socket.send(message);

          event.target.reset();
        });
      });

      // Listen for messages
      socket.addEventListener('message', function (event) {
        addMessage(event.data, 'server');
      });
    }

    window.addEventListener('DOMContentLoaded', (event) => {
      document.getElementById('form-connect').addEventListener('submit', (event) => {
          event.preventDefault();
          const username = document.getElementById('username').value;
          connectWebSocket(username);
      });
    });
  </script>
</body>

</html>
